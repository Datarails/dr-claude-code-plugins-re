╔════════════════════════════════════════════════════════════════════════════════╗
║                    JUPYTER NOTEBOOK - QUICK FIX                                ║
║                         Token Expired (401 Error)                              ║
╚════════════════════════════════════════════════════════════════════════════════╝

ERROR YOU'RE SEEING:
  KeyError: 'records_returned'
  OR
  Status Code: 401

WHY IT'S HAPPENING:
  ✗ Authentication token expired (valid only ~5 minutes)
  ✓ This is NORMAL - tokens need to be refreshed

QUICK FIX (2 MINUTES):
════════════════════════════════════════════════════════════════════════════════

1. COPY THIS ENTIRE COMMAND AND RUN IT IN TERMINAL:

python3 << 'EOF'
import sys
sys.path.insert(0, "/Users/stasg/DataRails-dev/dr-claude-code-plugins-re/mcp-server/src")
import asyncio
from datarails_mcp.auth import get_auth

async def refresh():
    auth = get_auth("app")
    await auth.ensure_valid_token()
    headers = auth.get_headers()
    jwt = headers.get('Authorization', '').replace('Bearer ', '')
    csrf = headers.get('X-CSRFToken', '')
    print("JWT_TOKEN:")
    print(jwt)
    print("\nCSRF_TOKEN:")
    print(csrf)

asyncio.run(refresh())
EOF

════════════════════════════════════════════════════════════════════════════════

2. COPY THE OUTPUT (Two long strings)

3. IN JUPYTER NOTEBOOK:
   a) Find the "Authentication Configuration" cell
   b) Replace the jwt_token value (entire string)
   c) Replace the csrf_token value (entire string)
   d) Run the cell (Shift+Enter)

4. RUN THIS CELL:
   api = DatarailsAPI(CONFIG)
   print("✓ API client reinitialized")

5. RE-RUN YOUR TEST:
   • Go back to the failing test
   • Run it again
   • Should now say "Status Code: 200" instead of 401

════════════════════════════════════════════════════════════════════════════════

VERIFICATION - TEST IF IT WORKED:

In a notebook cell, run:
    records, metadata = await api.fetch_data(limit=10, offset=0)
    print(f"Status: {metadata['status_code']}")

EXPECTED OUTPUT:
    Status: 200

════════════════════════════════════════════════════════════════════════════════

THAT'S IT! You're ready to run the tests now.

════════════════════════════════════════════════════════════════════════════════

PREVENTION: Run tests within ~5 minutes of opening the notebook.
After 5+ minutes, refresh credentials before running more tests.

════════════════════════════════════════════════════════════════════════════════
